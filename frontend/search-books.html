<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search Books</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/search-books.css">
</head>
<body>

<header class="topbar">
    <h1>Search Collection</h1>
    <a href="#" class="logout" id="back-link">Back</a>
</header>

<main class="search-container">

    <div class="search-header">
        <form onsubmit="handleSearch(event)" class="search-box">
            <input type="text" id="search-input" placeholder="Search by Title..." required>
            
            <select id="category-filter">
                <option value="all">All Categories</option>
                <option value="SCIENCE">Science</option>
                <option value="RELIGION">Religion</option>
                <option value="ART">Art</option>
                <option value="HISTORY">History</option>
                <option value="GEOGRAPHY">Geography</option>
            </select>

            <button type="submit" class="action-btn">Search</button>
        </form>
    </div>

    <div class="results-grid" id="results-area"></div>
    <div id="no-results" class="no-results hidden"><p>No books found.</p></div>

</main>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role'); // 'admin' or 'customer'
    
    // Back Link Logic
    const backLink = document.getElementById('back-link');
    if (role === 'admin') {
        backLink.href = 'admin.html';
        backLink.innerText = 'Back to Dashboard';
    } else {
        backLink.href = 'customer.html';
        backLink.innerText = 'Back to Home';
    }

    // 1. Load All Books on Start
    window.onload = async function() {
        await loadBooks();
    };

    async function loadBooks(categoryFilter = 'all', textQuery = '') {
        try {
            // Fetch all books (Simplest approach for prototype)
            // Ideally, backend has /search endpoint. Here we filter client-side for smoother UI.
            const response = await fetch('http://localhost:8080/api/books');
            const allBooks = await response.json();

            // Filter
            const filtered = allBooks.filter(book => {
                const matchesText = !textQuery || book.title.toLowerCase().includes(textQuery.toLowerCase());
                const matchesCat = categoryFilter === 'all' || book.category === categoryFilter.toUpperCase(); // Backend enum is uppercase
                return matchesText && matchesCat;
            });

            renderBooks(filtered);
        } catch (e) {
            console.error("Error loading books", e);
        }
    }

    function handleSearch(event) {
        event.preventDefault();
        const query = document.getElementById('search-input').value;
        const cat = document.getElementById('category-filter').value;
        loadBooks(cat, query);
    }

    function renderBooks(books) {
        const grid = document.getElementById('results-area');
        const noRes = document.getElementById('no-results');
        grid.innerHTML = ''; 

        if (books.length === 0) {
            noRes.style.display = 'block';
            return;
        } else {
            noRes.style.display = 'none';
        }

        books.forEach(book => {
            let actionBtn = '';
            if (role === 'admin') {
                // Pass ISBN as ID for update page
                actionBtn = `<a href="update-book.html?id=${book.isbn}" class="card-btn admin">Edit Details</a>`;
            } else {
                actionBtn = `<button class="card-btn customer" onclick="addToCart('${book.isbn}', '${book.title}')">Add to Cart</button>`;
            }

            // Colors for aesthetic
            const colors = ['#2f6f4e', '#1e3a8a', '#7f1d1d', '#0f766e', '#eab308'];
            const bg = colors[book.id % colors.length] || '#2f6f4e';

            grid.innerHTML += `
                <div class="book-card">
                    <div class="book-visual" style="background: ${bg}">
                        <span>${book.title.substring(0,1)}</span>
                    </div>
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <p class="author">Price: $${book.price}</p>
                        <div class="price-row">
                             <span class="tag">${book.category}</span>
                             <span class="price">Stock: ${book.stockQuantity}</span>
                        </div>
                        ${actionBtn}
                    </div>
                </div>`;
        });
    }

    async function addToCart(isbn, title) {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) { alert("Please login first"); return; }

        try {
            const res = await fetch('http://localhost:8080/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: user.id, bookIsbn: isbn, quantity: 1 })
            });
            if (res.ok) alert(title + " added to cart!");
            else alert("Failed to add to cart.");
        } catch (e) { alert("Network Error"); }
    }
</script>

</body>
</html>