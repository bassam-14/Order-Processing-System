<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Confirm Publisher Orders</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/confirm-orders.css">
</head>
<body>

<header class="topbar">
    <h1>Replenishment Orders</h1>
    <a href="admin.html" class="logout">Back</a>
</header>

<main class="orders-container">

    <div class="header-summary">
        <h2>Pending Shipments</h2>
        <p class="subtitle">Confirm receipt of books from publishers to update stock levels.</p>
    </div>

    <table class="orders-table">
        <thead>
        <tr>
            <th>Order ID</th>
            <th>Book ISBN</th>
            <th>Quantity</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="orders-list">
            </tbody>
    </table>

</main>

<script>
    // 1. Load All Orders
    window.onload = async function() {
        try {
            const response = await fetch('http://localhost:8080/api/publisher-orders');
            const orders = await response.json();
            const tbody = document.getElementById('orders-list');
            
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No active orders found.</td></tr>';
                return;
            }

            orders.forEach(order => {
                let actionHtml = '';
                let statusClass = 'pending';

                if (order.status === 'RECEIVED') {
                    statusClass = 'success';
                    actionHtml = `<button class="action-btn small" disabled style="opacity:0.5; cursor:default;">Completed</button>`;
                } else {
                    actionHtml = `<button class="action-btn small" onclick="confirmOrder(${order.id})">Confirm Receipt</button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td class="id-col">#${order.id}</td>
                        <td>${order.bookIsbn}</td>
                        <td class="qty-col">${order.quantity}</td>
                        <td><span class="badge ${statusClass}">${order.status}</span></td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
            });
        } catch (e) {
            console.error(e);
            alert("Error loading orders.");
        }
    };

    // 2. Handle Confirm Button
    async function confirmOrder(orderId) {
        if(!confirm("Confirm that these books have arrived? Stock will be updated.")) return;

        try {
            // Sends request to: PUT /api/publisher-orders/5/status?status=RECEIVED
            const response = await fetch(`http://localhost:8080/api/publisher-orders/${orderId}/status?status=RECEIVED`, {
                method: 'PUT'
            });

            if (response.ok) {
                alert("Stock Updated Successfully!");
                window.location.reload(); // Refresh to show new status
            } else {
                alert("Error updating status.");
            }
        } catch (e) {
            alert("Network Error");
        }
    }
</script>

</body>
</html>