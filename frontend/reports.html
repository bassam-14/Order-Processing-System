<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Reports</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/reports.css">
</head>
<body>

<header class="topbar">
    <h1>System Reports</h1>
    <a href="admin.html" class="logout">Back</a>
</header>

<main class="reports-container">

    <section class="report-card full-width">
        <div class="card-header">
            <h2>Monthly Sales Report</h2>
            <p class="subtitle">Total sales for the previous month</p>
        </div>
        <div class="stat-box">
            <span class="currency">$</span>
            <span class="amount" id="monthly-total">0.00</span>
        </div>
    </section>

    <section class="report-card">
        <h2>Daily Sales Lookup</h2>
        <p class="subtitle">View total sales for a specific date.</p>
        
        <form onsubmit="handleDailySales(event)" class="search-form">
            <input type="date" id="sales-date" required>
            <button type="submit" class="action-btn small">View</button>
        </form>

        <div id="daily-result" class="result-box hidden">
            <p>Total Sales on <span id="display-date" style="color:white">...</span>:</p>
            <strong class="highlight-green" id="display-amount">$0.00</strong>
        </div>
    </section>

    <section class="report-card">
        <h2>Replenishment Stats</h2>
        <p class="subtitle">Check how many times a book was re-ordered (Enter ISBN).</p>
        
        <form onsubmit="handleReplenishSearch(event)" class="search-form">
            <input type="text" id="book-search" placeholder="Enter ISBN (e.g. 978-013...)" required>
            <button type="submit" class="action-btn small">Search</button>
        </form>

        <div id="replenish-result" class="result-box hidden">
            <p>ISBN: <span id="r-book" style="color:white">...</span></p>
            <p>Times Ordered by Admin: <strong class="highlight-blue" id="r-count">0</strong></p>
        </div>
    </section>

    <section class="report-card">
        <h2>Top 5 Customers</h2>
        <p class="subtitle">Best customers (Last 3 Months)</p>
        <table class="data-table">
            <thead>
            <tr>
                <th>Rank</th>
                <th>Customer</th>
                <th>Total Spent</th>
            </tr>
            </thead>
            <tbody id="top-customers-list"></tbody>
        </table>
    </section>

    <section class="report-card">
        <h2>Top Selling Books</h2>
        <p class="subtitle">Highest quantity sold (Last 3 Months)</p>
        <table class="data-table">
            <thead>
            <tr>
                <th>Rank</th>
                <th>Book Title</th>
                <th>Sold</th>
            </tr>
            </thead>
            <tbody id="top-books-list"></tbody>
        </table>
    </section>

</main>

<script>
    // 1. Load Initial Data (Monthly, Top Customers, Top Books)
    window.onload = async function() {
        try {
            // A. Monthly Sales
            const resSales = await fetch('http://localhost:8080/api/reports/sales/prev-month');
            const sales = await resSales.json();
            document.getElementById('monthly-total').innerText = (sales || 0).toFixed(2);

            // B. Top Customers
            const resCust = await fetch('http://localhost:8080/api/reports/top-customers');
            const customers = await resCust.json();
            const custBody = document.getElementById('top-customers-list');
            custBody.innerHTML = '';
            customers.forEach((c, index) => {
                custBody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${c.username}</td>
                        <td>$${c.total_spent ? c.total_spent.toFixed(2) : '0.00'}</td>
                    </tr>`;
            });

            // C. Top Books
            const resBooks = await fetch('http://localhost:8080/api/reports/top-books');
            const books = await resBooks.json();
            const bookBody = document.getElementById('top-books-list');
            bookBody.innerHTML = '';
            books.forEach((b, index) => {
                bookBody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${b.title}</td>
                        <td>${b.copies_sold}</td>
                    </tr>`;
            });

        } catch (e) {
            console.error("Error loading reports", e);
        }
    };

    // 2. Handle Daily Sales
    async function handleDailySales(event) {
        event.preventDefault();
        const dateInput = document.getElementById('sales-date').value;
        if(!dateInput) return;

        try {
            const response = await fetch(`http://localhost:8080/api/reports/sales/day?date=${dateInput}`);
            const total = await response.json();
            
            document.getElementById('display-date').innerText = dateInput;
            document.getElementById('display-amount').innerText = "$" + (total || 0).toFixed(2);
            
            const resultBox = document.getElementById('daily-result');
            resultBox.classList.remove('hidden');
            resultBox.classList.add('fade-in');
        } catch (e) {
            alert("Error fetching daily sales");
        }
    }

    // 3. Handle Replenishment Search
    async function handleReplenishSearch(event) {
        event.preventDefault();
        const isbn = document.getElementById('book-search').value;
        
        try {
            const response = await fetch(`http://localhost:8080/api/reports/restock/${isbn}`);
            const count = await response.json();

            document.getElementById('r-book').innerText = isbn;
            document.getElementById('r-count').innerText = count + " times";

            const resultBox = document.getElementById('replenish-result');
            resultBox.classList.remove('hidden');
            resultBox.classList.add('fade-in');
        } catch (e) {
            alert("Error fetching restock stats. Check ISBN.");
        }
    }
</script>

</body>
</html>