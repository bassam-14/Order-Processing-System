<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Checkout</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/checkout.css">
</head>
<body>

<header class="topbar">
    <h1>Secure Checkout</h1>
    <a href="cart.html" class="logout">Cancel</a>
</header>

<main class="checkout-container">

    <div class="checkout-card">
        
        <div class="card-preview">
            <div class="chip"></div>
            <div class="logo">Visa</div>
            <div class="card-number-display" id="display-number">#### #### #### ####</div>
            <div class="card-details">
                <div class="card-holder-display" id="display-name">YOUR NAME</div>
                <div class="card-expiry-display" id="display-expiry">MM/YY</div>
            </div>
        </div>

        <h2 style="margin-top: 20px;">Payment Details</h2>
        <p class="subtitle">Complete your purchase</p>

        <form onsubmit="handlePayment(event)">
            
            <div class="input-group">
                <label>Card Number</label>
                <input type="text" id="card-number" placeholder="0000 0000 0000 0000" 
                       maxlength="19" required
                       oninput="formatCardNumber(this)">
            </div>

            <div class="input-group">
                <label>Cardholder Name</label>
                <input type="text" id="card-name" placeholder="JOHN DOE" required 
                       oninput="formatCardName(this)">
            </div>

            <div class="row">
                <div class="input-group">
                    <label>Expiry Date</label>
                    <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" required
                           oninput="formatExpiry(this)">
                </div>
                
                <div class="input-group">
                    <label>CVV</label>
                    <input type="password" placeholder="123" maxlength="3" required 
                           oninput="formatCVV(this)"
                           style="letter-spacing: 3px;">
                </div>
            </div>

            <button type="submit" class="action-btn">Pay Now</button>
        </form>

        <p class="secure-text">ðŸ”’ Payments are secure and encrypted.</p>
    </div>

</main>

<script>
    async function handlePayment(event) {
        event.preventDefault();
        const user = JSON.parse(localStorage.getItem('currentUser'));

        if (!user) {
            alert("Session expired. Please login again.");
            window.location.href = 'login.html';
            return;
        }

        const paymentDetails = {
            creditCardNumber: document.getElementById('card-number').value,
            creditCardExpiry: document.getElementById('card-expiry').value
        };

        try {
            const response = await fetch(`http://localhost:8080/api/orders/checkout/${user.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentDetails)
            });

            if (response.ok) {
                window.location.href = 'order-success.html';
            } else {
                alert("Checkout Failed: " + await response.text());
            }
        } catch (error) {
            console.error(error);
            alert("Network error during checkout.");
        }
    }

    // Formatting Helpers
    function formatCardNumber(input) {
        let value = input.value.replace(/\D/g, '').substring(0, 16);
        let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
        input.value = formatted;
        document.getElementById('display-number').innerText = formatted || '#### #### #### ####';
    }
    function formatExpiry(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length >= 2) {
            if (parseInt(value.substring(0,2)) > 12) value = '12' + value.substring(2);
            value = value.substring(0,2) + '/' + value.substring(2,4);
        }
        input.value = value;
        document.getElementById('display-expiry').innerText = value || 'MM/YY';
    }
    function formatCardName(input) {
        input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
        document.getElementById('display-name').innerText = input.value.toUpperCase() || 'YOUR NAME';
    }
    function formatCVV(input) { input.value = input.value.replace(/\D/g, ''); }
</script>

</body>
</html>