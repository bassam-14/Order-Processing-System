<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Book Details</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/update-book.css">
</head>
<body>

<header class="topbar">
    <h1>Update Book Details</h1>
    <a href="#" class="logout" id="back-link">Back</a>
</header>

<main class="container">

    <div id="search-section" class="card search-card">
        <h2>Find Book to Edit</h2>
        <p class="subtitle">Enter the ISBN of the book you want to update.</p>
        
        <form id="search-form-internal" onsubmit="handleFindBook(event)" class="find-form">
            <input type="text" id="find-input" placeholder="e.g. 978-..." required>
            <button type="submit" class="action-btn">Find Book</button>
        </form>
        
        <p id="error-msg" class="error" style="display:none;">Book not found.</p>
    </div>

    <div id="edit-section" class="card edit-card hidden">
        <div class="card-header">
            <h2>Edit Book Details</h2>
            <p class="subtitle">Update pricing, stock, or metadata.</p>
        </div>

        <form onsubmit="handleUpdate(event)">
            
            <div class="input-group">
                <label>ISBN (Read Only)</label>
                <input type="text" id="book-isbn" readonly 
                       style="opacity: 0.6; cursor: not-allowed;">
            </div>

            <div class="form-row">
                <div class="input-group">
                    <label>Book Title</label>
                    <input type="text" id="book-title" required minlength="2">
                </div>
                <div class="input-group">
                    <label>Publisher ID</label>
                    <input type="number" id="book-publisher-id" required>
                </div>
            </div>

            <div class="form-row">
                <div class="input-group">
                    <label>Category</label>
                    <select id="book-category">
                        <option value="Science">Science</option>
                        <option value="Technology">Technology</option>
                        <option value="Fiction">Fiction</option>
                        <option value="History">History</option>
                        <option value="Geography">Geography</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Price ($)</label>
                    <input type="number" id="book-price" step="0.01" min="0.01" required>
                </div>
            </div>

            <div class="input-group">
                <label>Threshold (Min Stock)</label>
                <input type="number" id="book-threshold" min="0" required>
            </div>
            
             <div class="input-group">
                <label>Publication Year</label>
                <input type="number" id="book-year" required>
            </div>

            <div class="actions">
                <button type="submit" class="action-btn" id="save-btn">Update Record</button>
            </div>
        </form>
    </div>

</main>

<script>
    // 1. CHECK URL (If coming from search page)
    const params = new URLSearchParams(window.location.search);
    const urlId = params.get('id'); // 'id' here corresponds to ISBN in our logic
    const backLink = document.getElementById('back-link');

    if (urlId) {
        backLink.href = 'search-books.html?role=admin';
        backLink.innerText = 'Back to Search';
        loadBookData(urlId); 
    } else {
        backLink.href = 'admin.html';
        backLink.innerText = 'Back to Dashboard';
        document.getElementById('search-section').style.display = 'block';
    }

    // 2. LOAD DATA
    async function loadBookData(isbn) {
        try {
            const response = await fetch(`http://localhost:8080/api/books/${isbn}`);
            if (response.ok) {
                const book = await response.json();
                
                // Fill Fields
                document.getElementById('book-isbn').value = book.isbn;
                document.getElementById('book-title').value = book.title;
                document.getElementById('book-publisher-id').value = book.publisherId;
                document.getElementById('book-price').value = book.price;
                document.getElementById('book-category').value = book.category;
                document.getElementById('book-threshold').value = book.threshold;
                document.getElementById('book-year').value = book.publicationYear;

                // Show Edit UI
                document.getElementById('search-section').style.display = 'none';
                document.getElementById('edit-section').style.display = 'block';
                document.getElementById('edit-section').classList.remove('hidden');
            } else {
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').innerText = "Book not found (Check ISBN)";
            }
        } catch (e) {
            console.error(e);
            alert("Connection Error");
        }
    }

    // 3. HANDLE SEARCH SUBMISSION
    function handleFindBook(event) {
        event.preventDefault(); 
        const query = document.getElementById('find-input').value;
        if(query) loadBookData(query);
    }

    // 4. HANDLE UPDATE
    async function handleUpdate(event) {
        event.preventDefault();
        const isbn = document.getElementById('book-isbn').value;
        
        const updatedBook = {
            isbn: isbn,
            title: document.getElementById('book-title').value,
            publisherId: parseInt(document.getElementById('book-publisher-id').value),
            category: document.getElementById('book-category').value,
            price: parseFloat(document.getElementById('book-price').value),
            threshold: parseInt(document.getElementById('book-threshold').value),
            publicationYear: parseInt(document.getElementById('book-year').value)
        };

        try {
            const response = await fetch(`http://localhost:8080/api/books/${isbn}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedBook)
            });

            if (response.ok) {
                alert("Book Updated Successfully!");
                window.location.href = "admin.html";
            } else {
                alert("Update failed: " + await response.text());
            }
        } catch (e) {
            alert("Network error");
        }
    }
</script>

</body>
</html>