<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/cart.css">
</head>
<body>

<header class="topbar">
    <h1>My Cart</h1>
    <a href="customer.html" class="logout">Back</a>
</header>

<main class="cart-container">

    <table class="cart-table">
        <thead>
        <tr>
            <th>Book</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="cart-items">
            </tbody>
    </table>

    <div class="cart-summary">
        <div class="totals">
            <p><strong>Total Items:</strong> <span id="summary-items">0</span></p>
            <p class="total-price"><strong>Total Price:</strong> <span id="summary-total">$0.00</span></p>
        </div>
        <a href="checkout.html" class="action">Checkout</a>
    </div>

</main>

<script>
    window.onload = async function() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) { window.location.href = 'login.html'; return; }

        try {
            const response = await fetch(`http://localhost:8080/api/cart/${user.id}`);
            const cartItems = await response.json();

            const tbody = document.getElementById('cart-items');
            tbody.innerHTML = '';
            
            let totalItems = 0;
            let totalPrice = 0;

            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                totalItems += item.quantity;
                totalPrice += itemTotal;

                tbody.innerHTML += `
                <tr class="cart-row">
                    <td>${item.bookTitle}</td>
                    <td class="price">$${item.price.toFixed(2)}</td>
                    <td>
                        <input type="number" value="${item.quantity}" min="1" class="qty-input" 
                               onchange="updateQuantity('${item.bookIsbn}', this.value)">
                    </td>
                    <td class="item-total">$${itemTotal.toFixed(2)}</td>
                    <td><button class="remove-btn" onclick="removeItem('${item.bookIsbn}')">Remove</button></td>
                </tr>`;
            });

            document.getElementById('summary-items').innerText = totalItems;
            document.getElementById('summary-total').innerText = '$' + totalPrice.toFixed(2);
        } catch (error) {
            console.error("Error loading cart:", error);
        }
    };

    async function updateQuantity(isbn, newQty) {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        await fetch(`http://localhost:8080/api/cart/update?userId=${user.id}&isbn=${isbn}&quantity=${newQty}`, { method: 'PUT' });
        location.reload(); 
    }

    async function removeItem(isbn) {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        await fetch(`http://localhost:8080/api/cart/${user.id}/remove/${isbn}`, { method: 'DELETE' });
        location.reload();
    }
</script>

</body>
</html>